
api@help: ## ğŸ“‹ Show this help message with all available targets
	cd src/api
	@echo ""
	@echo "ğŸ›ï¸  $(PROJECT_TITLE) - Makefile Commands"
	@echo "ğŸ“  $(PROJECT_DESCRIPTION)"
	@echo ""
	@echo "ğŸ“‹ Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

#===================================================================================================
#=== Setup and Installation Targets
#===================================================================================================

api@info: ## ğŸ“‹ Show project information and current configuration
	cd src/api
	@echo ""
	@echo "ğŸ›ï¸  Project Information:"
	@echo "  ğŸ“› Name: $(PROJECT_NAME)"
	@echo "  ğŸ“ Title: $(PROJECT_TITLE)"
	@echo "  ï¿½ Description: $(PROJECT_DESCRIPTION)"
	@echo "  ğŸ”¢ Version: $(VERSION)"
	@echo "  ğŸ†” Build ID: $(BUILD_ID)"
	@echo "  ğŸŒ Domain: $(DOMAIN)"
	@echo ""
	@echo "ğŸ”§ Development Configuration:"
	@echo "  ğŸ“¦ Node Version: $(NVM_NODE_VERSION)"
	@echo "  ğŸŒ Dev Port: $(DEV_PORT)"
	@echo "  ğŸ” Preview Port: $(PREVIEW_PORT)"
	@echo "  ğŸ—ï¸  Build Mode: $(BUILD_MODE)"
	@echo "  ğŸ—ºï¸  Source Maps: $(SOURCE_MAP)"
	@echo ""
	@echo "ğŸ‘¤ System Information:"
	@echo "  ï¿½ Shell: $(SHELL_NAME) $(SHELL_VERSION)"
	@echo "  ğŸ‘¤ User: $(USERNAME) ($(UID):$(GID))"
	@echo ""

api@install: ## ğŸ“¦ Install all project dependencies
	cd src/api
	@echo "ï¿½ Installing dependencies for Azure Functions backend..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@echo "ğŸ“‹ Node.js version: $$(node --version)"
	@echo "ï¿½ NPM version: $$(npm --version)"
	@echo "ï¿½ Application version: $(VERSION)-$(BUILD_ID)"
	@npm install --legacy-peer-deps
	@echo "âœ… Dependencies installed successfully!"

api@setup: api@install ## ğŸš€ Complete project setup (install + environment check)
	cd src/api
	@echo "ğŸš€ Setting up $(PROJECT_TITLE) development environment..."
	@$(MAKE) deps-check
	@$(MAKE) type-check
	@echo "âœ… Project setup complete! Run 'make dev' to start development."

#===================================================================================================
#=== Build Targets
#===================================================================================================

api@build: ## ğŸ”¨ Build Azure Functions backend for production
	cd src/api
	@echo "ğŸ”¨ Building Azure Functions backend for production..."
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@echo "ğŸ“‹ Node.js version: $$(node --version)"
	@echo "ï¿½ NPM version: $$(npm --version)"
	@echo "ğŸ§¹ Cleaning previous build..."
	@rm -rf dist/
	@echo "ğŸ”¨ Building with NestJS..."
	@npm run build
	@echo "âœ… Backend built successfully!"
	@echo "ï¿½ Built files are in the dist/ directory:"
	@ls -la dist/ | head -10
	@echo "ï¿½ Build size analysis:"
	@du -sh dist/
	@echo "ğŸ‰ Backend build complete!"

api@build-staging: ## ï¿½ Build application for staging environment
	cd src/api
	@echo "ğŸ”¨ Building $(PROJECT_TITLE) for staging..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@NODE_ENV=staging VITE_APP_VERSION=$(VERSION)-staging VITE_BUILD_ID=$(BUILD_ID) npm run build
	@echo "âœ… Staging build complete!"

api@build-analyze: build ## ï¿½ Build and analyze bundle size
	cd src/api
	@echo "ï¿½ Analyzing bundle size..."
	@npx vite-bundle-analyzer dist/


#===================================================================================================
#=== Development Targets
#===================================================================================================

api@dev-check: ## ğŸ” Run pre-development checks (types, lint, format)
	cd src/api
	@echo "ğŸ” Running pre-development checks..."
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@npm run dev:check
	@echo "âœ… Pre-development checks passed!"

api@dev: ## ğŸš€ Start Azure Functions backend in hybrid mode
	cd src/api
	@echo "ğŸš€ Starting Azure Functions backend in hybrid mode..."
	@echo "ğŸ“ Functions will be available at: http://localhost:$(API_FAPP_DEV_PORT)"
	@echo "ğŸ—ï¸ Architecture: Hybrid (NestJS HTTP + Native Triggers)"
	@echo "ğŸ“– API endpoints:"
	@echo "  â€¢ POST /api/storage/generate-sas - Generate SAS tokens"
	@echo "  â€¢ POST /api/validation/uuid - Validate UUIDs"
	@echo "  â€¢ GET  /api/health - Health check"
	@echo "  â€¢ GET  /api/docs - Swagger documentation"
	@echo "âš¡ Native Functions:"
	@echo "  â€¢ Timer: schedule-cleanup (daily at 2 AM UTC)"
	@echo "  â€¢ Queue: queue-processor (task-queue)"
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@echo "ï¿½ Node.js version: $$(node --version)"
	npm run dev

api@dev-nestjs: ## ğŸš€ Start NestJS HTTP development server (without pre-checks)
	cd src/api
	@echo "ğŸš€ Starting NestJS HTTP development server..."
	@echo "ğŸ“ Server will be available at: http://localhost:$(API_NEST_DEV_PORT)"
	@echo "ğŸ“– API docs will be available at: http://localhost:$(API_NEST_DEV_PORT)/api/docs"
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@npm run start:debug

api@dev-adapter: ## ğŸš€ Start NestJS with Serverless Adapter (development)
	cd src/api
	@echo "ğŸš€ Starting NestJS with H4AD Serverless Adapter..."
	@echo "ğŸ“ Server will be available at: http://localhost:$(API_NEST_DEV_PORT)"
	@echo "ğŸ“– API docs will be available at: http://localhost:$(API_NEST_DEV_PORT)/api/docs"
	@echo "ğŸ”§ Architecture: H4AD Serverless Adapter + NestJS"
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@npm run start:adapter

api@dev-strict: ## ğŸš€ Start development server with strict pre-checks + Azure Storage Emulator
	cd src/api
	@echo "ğŸš€ Starting $(PROJECT_TITLE) development server with strict checks..."
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@echo "ğŸ“‹ Node.js version: $$(node --version)"
	@echo "ğŸ” Running pre-development checks..."
	@$(MAKE) dev-check
	@echo "âœ… Pre-development checks passed!"
	@echo "ğŸŒ Starting parallel services with Azure Storage Emulator..."
	npm run dev:strict

api@preview: api@build ## ğŸ” Preview production build locally
	cd src/api
	@echo "ï¿½ Starting preview server for production build..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@echo "ğŸ“‹ Node.js version: $$(node --version)"
	@echo "ğŸŒ Starting preview server on http://$(DEV_HOST):$(PREVIEW_PORT)"
	@npm run preview

api@serve: api@build ## ğŸŒ Serve production build locally
	cd src/api
	@echo "ğŸŒ Serving production build..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@echo "ğŸ“ Serving from dist/ directory"
	@npx serve dist -p $(DEV_PORT) -s
	@echo "ğŸŒ Application available at http://$(DEV_HOST):$(DEV_PORT)"

#===================================================================================================
#=== Security and Maintenance Targets
#===================================================================================================

api@audit: ## ğŸ”’ Run npm security audit
	cd src/api
	@echo "ï¿½ Running security audit..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@npm audit --audit-level=moderate
	@echo "âœ… Security audit completed!"

api@security-audit: ## ğŸ”’ Run comprehensive security audit with fix suggestions
	cd src/api
	@echo "ï¿½ Running comprehensive security audit..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@npm audit --audit-level=low
	@echo "ğŸ’¡ To fix issues automatically, run: npm audit fix"
	@echo "âœ… Security audit completed!"

api@update: ## ğŸ“¦ Update npm dependencies (interactive)
	cd src/api
	@echo "ï¿½ Updating dependencies..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@npx npm-check-updates --interactive
	@echo "âœ… Dependencies updated!"

api@deps-check: ## ğŸ” Check for outdated dependencies
	cd src/api
	@echo "ï¿½ Checking for outdated dependencies..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@npm outdated || true
	@echo "âœ… Dependency check completed!"

#===================================================================================================
#=== Azure Functions Specific Targets
#===================================================================================================



api@start: ## âš¡ Start Azure Functions backend
	cd src/api
	@echo "âš¡ Starting Azure Functions backend..."
	@echo "ğŸ“ Functions Host: http://localhost:$(API_FAPP_DEV_PORT)"
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	func start --port $(API_FAPP_DEV_PORT)

api@stop: ## â¹ï¸ Stop Azure Functions backend
	cd src/api
	@echo "â¹ï¸ Stopping Azure Functions backend..."
	pkill -f "func start" || true
	pkill -f "Azure.Functions.Cli" || true
	@echo "âœ… Azure Functions stopped"

api@status: ## ğŸ“Š Check backend status
	cd src/api
	@echo "ğŸ“Š Azure Functions backend status:"
	@if pgrep -f "func start" > /dev/null; then \
		echo "âœ… Backend is running"; \
		echo "ğŸ“ Available at: http://localhost:$(API_FAPP_DEV_PORT)"; \
	else \
		echo "âŒ Backend is not running"; \
	fi

api@logs: ## ğŸ“‹ Show backend logs
	cd src/api
	@echo "ğŸ“‹ Showing Azure Functions logs..."
	@if [ -f "$(HOME)/.azure-functions-core-tools/logs/host.log" ]; then \
		tail -f "$(HOME)/.azure-functions-core-tools/logs/host.log"; \
	else \
		echo "âš ï¸ No log file found. Make sure Azure Functions is running."; \
	fi

api@health: ## ğŸ¥ Check backend health
	cd src/api
	@echo "ğŸ¥ Checking backend health..."
	@if curl -s -f http://localhost:$(API_FAPP_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "âœ… Backend is healthy"; \
		curl -s http://localhost:$(API_FAPP_DEV_PORT)/api/health | jq . || curl -s http://localhost:$(API_FAPP_DEV_PORT)/api/health; \
	else \
		echo "âŒ Backend is not responding"; \
		echo "ğŸ’¡ Start it with: make api@dev"; \
	fi

api@test-sas: ## ğŸ” Test SAS token generation
	cd src/api
	@echo "ğŸ” Testing SAS token generation..."
	@if curl -s -f http://localhost:$(API_FAPP_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ğŸ“¡ Sending SAS token request..."; \
		curl -X POST http://localhost:$(API_FAPP_DEV_PORT)/api/storage/generate-sas \
			-H "Content-Type: application/json" \
			-d '{"containerName": "reservations", "permissions": "rw", "expiryHours": 24}' \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@test-validation: ## âœ… Test validation endpoints
	cd src/api
	@echo "âœ… Testing validation endpoints..."
	@if curl -s -f http://localhost:$(API_FAPP_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ğŸ“¡ Testing UUID validation..."; \
		curl -X POST http://localhost:$(API_FAPP_DEV_PORT)/api/validation/uuid \
			-H "Content-Type: application/json" \
			-d '{"uuid": "123e4567-e89b-12d3-a456-426614174000"}' \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@docs: ## ğŸ“– Open API documentation
	cd src/api
	@echo "ğŸ“– Opening API documentation..."
	@if command -v xdg-open > /dev/null; then \
		xdg-open http://localhost:$(API_FAPP_DEV_PORT)/api/docs; \
	elif command -v open > /dev/null; then \
		open http://localhost:$(API_FAPP_DEV_PORT)/api/docs; \
	else \
		echo "ğŸ“ API docs available at: http://localhost:$(API_FAPP_DEV_PORT)/api/docs"; \
	fi

api@docs-nestjs: ## ğŸ“– Open NestJS API documentation
	cd src/api
	@echo "ğŸ“– Opening NestJS API documentation..."
	@if command -v xdg-open > /dev/null; then \
		xdg-open http://localhost:$(API_NEST_DEV_PORT)/api/docs; \
	elif command -v open > /dev/null; then \
		open http://localhost:$(API_NEST_DEV_PORT)/api/docs; \
	else \
		echo "ğŸ“ NestJS API docs available at: http://localhost:$(API_NEST_DEV_PORT)/api/docs"; \
	fi

#===================================================================================================
#=== Payment API Testing Targets
#===================================================================================================

api@test-payment-status: ## ğŸ¥ Test payment service status
	cd src/api
	@echo "ğŸ¥ Testing payment service status..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "âœ… Payment service is running"; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/status | jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/status; \
	else \
		echo "âŒ Payment service is not responding"; \
		echo "ğŸ’¡ Start it with: make api@dev-nestjs"; \
	fi

api@create-reservation: ## ğŸ“ Create a sample tourist tax reservation
	cd src/api
	@echo "ğŸ“ Creating sample tourist tax reservation..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "ğŸ“¡ Sending reservation creation request..."; \
		curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payment/reservations \
			-H "Content-Type: application/json" \
			-d '{"guestName":"Jan Kowalski","guestEmail":"jan.kowalski@example.com","accommodationName":"Hotel Test","accommodationAddress":"ul. Testowa 1, 31-000 KrakÃ³w","checkInDate":"2025-08-15","checkOutDate":"2025-08-18","numberOfGuests":2,"numberOfNights":3,"taxAmountPerNight":2.50,"totalTaxAmount":15.00,"currency":"PLN","cityName":"KrakÃ³w"}' \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi

api@list-reservations: ## ğŸ“‹ List all reservations
	cd src/api
	@echo "ğŸ“‹ Fetching all reservations..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "ğŸ“¡ Fetching reservations..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/reservations \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/reservations; \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi

api@initiate-payment: ## ğŸ’³ Initiate payment for a reservation (requires RESERVATION_ID)
	cd src/api
	@echo "ğŸ’³ Initiating payment for reservation..."
	@if [ -z "$(RESERVATION_ID)" ]; then \
		echo "âŒ RESERVATION_ID is required. Usage: make api@initiate-payment RESERVATION_ID=your-uuid"; \
		echo "ğŸ’¡ Get reservation IDs with: make api@list-reservations"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "ğŸ“¡ Initiating payment for reservation $(RESERVATION_ID)..."; \
		curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payment/initiate \
			-H "Content-Type: application/json" \
			-d '{"reservationId":"$(RESERVATION_ID)","successUrl":"http://localhost:3040/payment/success","failureUrl":"http://localhost:3040/payment/failure"}' \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi

api@payment-status: ## ğŸ“Š Check payment status (requires PAYMENT_ID)
	cd src/api
	@echo "ğŸ“Š Checking payment status..."
	@if [ -z "$(PAYMENT_ID)" ]; then \
		echo "âŒ PAYMENT_ID is required. Usage: make api@payment-status PAYMENT_ID=your-payment-id"; \
		echo "ğŸ’¡ Get payment IDs with: make api@list-payments"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "ğŸ“¡ Fetching payment status for $(PAYMENT_ID)..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/$(PAYMENT_ID)/status \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/$(PAYMENT_ID)/status; \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi

api@list-payments: ## ğŸ’° List all payments
	cd src/api
	@echo "ğŸ’° Fetching all payments..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "ğŸ“¡ Fetching payments..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/payments \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/payments; \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi

api@simulate-webhook: ## ğŸ”” Simulate payment webhook (requires PAYMENT_ID and STATUS)
	cd src/api
	@echo "ğŸ”” Simulating payment webhook..."
	@if [ -z "$(PAYMENT_ID)" ]; then \
		echo "âŒ PAYMENT_ID is required. Usage: make api@simulate-webhook PAYMENT_ID=your-payment-id STATUS=completed"; \
		echo "ğŸ’¡ Valid statuses: pending, processing, completed, failed, cancelled"; \
		exit 1; \
	fi
	@if [ -z "$(STATUS)" ]; then \
		echo "âŒ STATUS is required. Usage: make api@simulate-webhook PAYMENT_ID=your-payment-id STATUS=completed"; \
		echo "ğŸ’¡ Valid statuses: pending, processing, completed, failed, cancelled"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "ğŸ“¡ Sending webhook for payment $(PAYMENT_ID) with status $(STATUS)..."; \
		curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payment/webhook \
			-H "Content-Type: application/json" \
			-d "{\"paymentId\":\"$(PAYMENT_ID)\",\"status\":\"$(STATUS)\",\"amount\":15.00,\"currency\":\"PLN\",\"transactionId\":\"txn_$$(date +%s)_test\",\"timestamp\":\"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi

api@get-reservation: ## ğŸ” Get specific reservation (requires RESERVATION_ID)
	cd src/api
	@echo "ğŸ” Fetching reservation details..."
	@if [ -z "$(RESERVATION_ID)" ]; then \
		echo "âŒ RESERVATION_ID is required. Usage: make api@get-reservation RESERVATION_ID=your-uuid"; \
		echo "ğŸ’¡ Get reservation IDs with: make api@list-reservations"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "ğŸ“¡ Fetching reservation $(RESERVATION_ID)..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/reservations/$(RESERVATION_ID) \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/reservations/$(RESERVATION_ID); \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi

api@delete-reservation: ## ğŸ—‘ï¸ Delete specific reservation (requires RESERVATION_ID)
	cd src/api
	@echo "ğŸ—‘ï¸ Deleting reservation..."
	@if [ -z "$(RESERVATION_ID)" ]; then \
		echo "âŒ RESERVATION_ID is required. Usage: make api@delete-reservation RESERVATION_ID=your-uuid"; \
		echo "ğŸ’¡ Get reservation IDs with: make api@list-reservations"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "ğŸ“¡ Deleting reservation $(RESERVATION_ID)..."; \
		curl -X DELETE http://localhost:$(API_NEST_DEV_PORT)/api/payment/reservations/$(RESERVATION_ID) \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi

api@clear-payment-data: ## ğŸ§¹ Clear all payment data and reseed with mock data
	cd src/api
	@echo "ğŸ§¹ Clearing all payment data..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo "ğŸ“¡ Clearing all data..."; \
		curl -X DELETE http://localhost:$(API_NEST_DEV_PORT)/api/payment/clear-all \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi

api@demo-payment-flow: ## ğŸ¬ Run complete payment flow demo
	cd src/api
	@echo "ğŸ¬ Running complete payment flow demo..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/payment/status > /dev/null 2>&1; then \
		echo ""; \
		echo "ğŸ¯ Step 1: Creating reservation..."; \
		RESERVATION_RESPONSE=$$(curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payment/reservations \
			-H "Content-Type: application/json" \
			-d '{"guestName":"Demo User","guestEmail":"demo@example.com","accommodationName":"Demo Hotel","accommodationAddress":"ul. Demo 1, 31-000 KrakÃ³w","checkInDate":"2025-08-15","checkOutDate":"2025-08-17","numberOfGuests":1,"numberOfNights":2,"taxAmountPerNight":2.50,"totalTaxAmount":5.00,"currency":"PLN","cityName":"KrakÃ³w"}'); \
		RESERVATION_ID=$$(echo $$RESERVATION_RESPONSE | jq -r '.id' 2>/dev/null || echo ""); \
		if [ -n "$$RESERVATION_ID" ] && [ "$$RESERVATION_ID" != "null" ]; then \
			echo "âœ… Reservation created: $$RESERVATION_ID"; \
			echo ""; \
			echo "ğŸ¯ Step 2: Initiating payment..."; \
			PAYMENT_RESPONSE=$$(curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payment/initiate \
				-H "Content-Type: application/json" \
				-d "{ \
					\"reservationId\": \"$$RESERVATION_ID\", \
					\"successUrl\": \"http://localhost:3040/payment/success\", \
					\"failureUrl\": \"http://localhost:3040/payment/failure\" \
				}"); \
			PAYMENT_ID=$$(echo $$PAYMENT_RESPONSE | jq -r '.paymentId' 2>/dev/null || echo ""); \
			if [ -n "$$PAYMENT_ID" ] && [ "$$PAYMENT_ID" != "null" ]; then \
				echo "âœ… Payment initiated: $$PAYMENT_ID"; \
				echo ""; \
				echo "ğŸ¯ Step 3: Simulating payment completion..."; \
				sleep 2; \
				curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payment/webhook \
					-H "Content-Type: application/json" \
					-d "{\"paymentId\":\"$$PAYMENT_ID\",\"status\":\"processing\",\"amount\":5.00,\"currency\":\"PLN\",\"transactionId\":\"txn_demo_$$(date +%s)\",\"timestamp\":\"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > /dev/null; \
				sleep 1; \
				curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payment/webhook \
					-H "Content-Type: application/json" \
					-d "{\"paymentId\":\"$$PAYMENT_ID\",\"status\":\"completed\",\"amount\":5.00,\"currency\":\"PLN\",\"transactionId\":\"txn_demo_$$(date +%s)\",\"timestamp\":\"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > /dev/null; \
				echo "âœ… Payment completed via webhook"; \
				echo ""; \
				echo "ğŸ¯ Step 4: Checking final status..."; \
				curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payment/$$PAYMENT_ID/status | jq . || echo "Final status check completed"; \
				echo ""; \
				echo "ğŸ‰ Demo completed successfully!"; \
				echo "ğŸ“ Reservation ID: $$RESERVATION_ID"; \
				echo "ğŸ“ Payment ID: $$PAYMENT_ID"; \
			else \
				echo "âŒ Failed to initiate payment"; \
			fi; \
		else \
			echo "âŒ Failed to create reservation"; \
		fi; \
	else \
		echo "âŒ Payment service is not running. Start it with: make api@dev-nestjs"; \
	fi
