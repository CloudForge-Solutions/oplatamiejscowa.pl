<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP: imoje Payment Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 15px 0; }
        .payment-form { background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .payment-status { text-align: center; padding: 20px; }
        .status-icon { font-size: 48px; margin-bottom: 10px; }
        .api-response { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>MVP: imoje Payment Integration Test</h1>
        <p><strong>Purpose:</strong> Test imoje payment gateway integration and flow</p>
        
        <div class="test-section">
            <h3>Payment Configuration</h3>
            <div class="form-group">
                <label>imoje API Endpoint:</label>
                <input type="text" id="api-endpoint" value="http://localhost:3001/api/payment" readonly>
            </div>
            <div class="form-group">
                <label>Merchant ID:</label>
                <input type="text" id="merchant-id" value="test-merchant-123" readonly>
            </div>
            <div class="form-group">
                <label>Service Key:</label>
                <input type="password" id="service-key" value="test-service-key" readonly>
            </div>
        </div>

        <div class="test-section">
            <h3>Tourist Tax Payment Form</h3>
            <div class="payment-form">
                <div class="form-group">
                    <label>Reservation ID:</label>
                    <input type="text" id="reservation-id" value="550e8400-e29b-41d4-a716-446655440000" readonly>
                </div>
                <div class="form-group">
                    <label>Amount (PLN):</label>
                    <input type="number" id="amount" value="15.00" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>Customer Email:</label>
                    <input type="email" id="customer-email" value="tourist@example.com">
                </div>
                <div class="form-group">
                    <label>Return URL:</label>
                    <input type="url" id="return-url" value="http://localhost:5173/payment-success">
                </div>
                <div class="form-group">
                    <label>Failure URL:</label>
                    <input type="url" id="failure-url" value="http://localhost:5173/payment-failure">
                </div>
                <button onclick="initiatePayment()" id="pay-btn">Pay Tourist Tax</button>
            </div>
        </div>

        <div class="test-section">
            <h3>Payment Status</h3>
            <div id="payment-status" class="payment-status">
                <div class="status-icon">üí≥</div>
                <div>Ready to process payment</div>
            </div>
        </div>

        <div class="test-section">
            <h3>API Communication Log</h3>
            <div id="api-log" class="api-response"></div>
        </div>

        <div class="test-section">
            <h3>Integration Analysis</h3>
            <button onclick="analyzeIntegration()">Analyze Integration</button>
            <div id="integration-analysis"></div>
        </div>
    </div>

    <script>
        let currentPaymentId = null;
        let statusCheckInterval = null;

        function logAPI(message, data = null) {
            const logDiv = document.getElementById('api-log');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            logDiv.textContent += logEntry + '\n\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updatePaymentStatus(status, message, icon = 'üí≥') {
            const statusDiv = document.getElementById('payment-status');
            statusDiv.innerHTML = `
                <div class="status-icon">${icon}</div>
                <div><strong>${status}</strong></div>
                <div>${message}</div>
            `;
        }

        async function initiatePayment() {
            const paymentData = {
                amount: parseFloat(document.getElementById('amount').value),
                currency: 'PLN',
                orderId: document.getElementById('reservation-id').value,
                customerEmail: document.getElementById('customer-email').value,
                returnUrl: document.getElementById('return-url').value,
                failureUrl: document.getElementById('failure-url').value,
                description: 'Tourist Tax Payment - Krak√≥w'
            };

            logAPI('üöÄ Initiating payment request', paymentData);
            updatePaymentStatus('Processing', 'Sending payment request to imoje...', '‚è≥');

            try {
                // Simulate API call to imoje
                const response = await simulateImojeAPI('/api/payment', 'POST', paymentData);
                
                if (response.ok) {
                    const paymentResponse = response.data;
                    currentPaymentId = paymentResponse.paymentId;
                    
                    logAPI('‚úÖ Payment initiated successfully', paymentResponse);
                    updatePaymentStatus('Pending', `Payment ID: ${paymentResponse.paymentId}`, '‚è≥');
                    
                    // Open payment URL in new window (simulate redirect)
                    const paymentWindow = window.open(paymentResponse.paymentUrl, 'imoje-payment', 'width=600,height=700');
                    
                    // Start status checking
                    startStatusChecking();
                    
                } else {
                    throw new Error(`Payment initiation failed: ${response.error}`);
                }
                
            } catch (error) {
                logAPI('‚ùå Payment initiation failed', { error: error.message });
                updatePaymentStatus('Failed', error.message, '‚ùå');
            }
        }

        async function simulateImojeAPI(endpoint, method, data = null) {
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            if (endpoint === '/api/payment' && method === 'POST') {
                // Simulate payment initiation
                const paymentId = 'pay_' + Math.random().toString(36).substr(2, 9);
                return {
                    ok: true,
                    data: {
                        paymentId: paymentId,
                        status: 'pending',
                        paymentUrl: `http://localhost:3001/payment/${paymentId}`,
                        amount: data.amount,
                        currency: data.currency
                    }
                };
            } else if (endpoint.includes('/api/payment/') && method === 'GET') {
                // Simulate status check
                const statuses = ['pending', 'processing', 'completed', 'failed'];
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                
                return {
                    ok: true,
                    data: {
                        paymentId: currentPaymentId,
                        status: randomStatus,
                        amount: parseFloat(document.getElementById('amount').value),
                        currency: 'PLN',
                        completedAt: randomStatus === 'completed' ? new Date().toISOString() : null
                    }
                };
            }
            
            return { ok: false, error: 'Unknown endpoint' };
        }

        function startStatusChecking() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(async () => {
                if (!currentPaymentId) return;
                
                try {
                    logAPI('üîç Checking payment status');
                    const response = await simulateImojeAPI(`/api/payment/${currentPaymentId}`, 'GET');
                    
                    if (response.ok) {
                        const status = response.data;
                        logAPI('üìä Status check result', status);
                        
                        switch (status.status) {
                            case 'pending':
                                updatePaymentStatus('Pending', 'Waiting for customer action...', '‚è≥');
                                break;
                            case 'processing':
                                updatePaymentStatus('Processing', 'Payment is being processed...', '‚öôÔ∏è');
                                break;
                            case 'completed':
                                updatePaymentStatus('Completed', `Payment successful! Amount: ${status.amount} ${status.currency}`, '‚úÖ');
                                clearInterval(statusCheckInterval);
                                break;
                            case 'failed':
                                updatePaymentStatus('Failed', 'Payment was declined or failed', '‚ùå');
                                clearInterval(statusCheckInterval);
                                break;
                        }
                    }
                } catch (error) {
                    logAPI('‚ùå Status check failed', { error: error.message });
                }
            }, 5000); // Check every 5 seconds
        }

        function analyzeIntegration() {
            const analysis = {
                strengths: [
                    'RESTful API design follows standard patterns',
                    'Webhook support for real-time status updates',
                    'Redirect-based flow works well for web applications',
                    'Support for multiple payment methods (cards, BLIK, etc.)'
                ],
                challenges: [
                    'Polling-based status checking is inefficient',
                    'Payment window management requires careful handling',
                    'Mobile integration needs special consideration',
                    'Error handling for network failures'
                ],
                recommendations: [
                    'Implement webhook endpoint for instant status updates',
                    'Add exponential backoff for status polling',
                    'Use postMessage API for payment window communication',
                    'Implement proper error recovery mechanisms'
                ],
                securityConsiderations: [
                    'Validate webhook signatures to prevent spoofing',
                    'Use HTTPS for all API communications',
                    'Implement proper CSRF protection',
                    'Store sensitive credentials securely'
                ],
                mobileOptimizations: [
                    'Use in-app browser for payment flow',
                    'Implement deep linking for return URLs',
                    'Handle app backgrounding during payment',
                    'Optimize for touch interfaces'
                ]
            };

            const resultDiv = document.getElementById('integration-analysis');
            resultDiv.innerHTML = `
                <div class="status info">
                    <strong>üîç imoje Integration Analysis</strong><br><br>
                    <strong>‚úÖ Strengths:</strong><br>
                    ${analysis.strengths.map(s => `‚Ä¢ ${s}`).join('<br>')}<br><br>
                    <strong>‚ö†Ô∏è Challenges:</strong><br>
                    ${analysis.challenges.map(c => `‚Ä¢ ${c}`).join('<br>')}<br><br>
                    <strong>üîß Recommendations:</strong><br>
                    ${analysis.recommendations.map(r => `‚Ä¢ ${r}`).join('<br>')}<br><br>
                    <strong>üõ°Ô∏è Security Considerations:</strong><br>
                    ${analysis.securityConsiderations.map(s => `‚Ä¢ ${s}`).join('<br>')}<br><br>
                    <strong>üì± Mobile Optimizations:</strong><br>
                    ${analysis.mobileOptimizations.map(m => `‚Ä¢ ${m}`).join('<br>')}
                </div>
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logAPI('üéØ imoje Payment Integration Test initialized');
            
            // Simulate receiving payment data from reservation
            const reservationData = {
                id: '550e8400-e29b-41d4-a716-446655440000',
                city: 'Krak√≥w',
                nights: 3,
                guests: 2,
                taxRate: 2.50,
                totalAmount: 15.00
            };
            
            logAPI('üìã Reservation data loaded', reservationData);
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        });
    </script>
</body>
</html>
