
api@help: ## ðŸ“‹ Show this help message with all available targets
	cd src/api
	@echo ""
	@echo "ðŸ›ï¸  $(PROJECT_TITLE) - Makefile Commands"
	@echo "ðŸ“  $(PROJECT_DESCRIPTION)"
	@echo ""
	@echo "ðŸ“‹ Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

#===================================================================================================
#=== Setup and Installation Targets
#===================================================================================================

api@info: ## ðŸ“‹ Show project information and current configuration
	cd src/api
	@echo ""
	@echo "ðŸ›ï¸  Project Information:"
	@echo "  ðŸ“› Name: $(PROJECT_NAME)"
	@echo "  ðŸ“ Title: $(PROJECT_TITLE)"
	@echo "  ï¿½ Description: $(PROJECT_DESCRIPTION)"
	@echo "  ðŸ”¢ Version: $(VERSION)"
	@echo "  ðŸ†” Build ID: $(BUILD_ID)"
	@echo "  ðŸŒ Domain: $(DOMAIN)"
	@echo ""
	@echo "ðŸ”§ Development Configuration:"
	@echo "  ðŸ“¦ Node Version: $(NVM_NODE_VERSION)"
	@echo "  ðŸŒ Dev Port: $(DEV_PORT)"
	@echo "  ðŸ” Preview Port: $(PREVIEW_PORT)"
	@echo "  ðŸ—ï¸  Build Mode: $(BUILD_MODE)"
	@echo "  ðŸ—ºï¸  Source Maps: $(SOURCE_MAP)"
	@echo ""
	@echo "ðŸ‘¤ System Information:"
	@echo "  ï¿½ Shell: $(SHELL_NAME) $(SHELL_VERSION)"
	@echo "  ðŸ‘¤ User: $(USERNAME) ($(UID):$(GID))"
	@echo ""

api@install: ## ðŸ“¦ Install all project dependencies
	cd src/api
	@echo "ï¿½ Installing dependencies for Azure Functions backend..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@echo "ðŸ“‹ Node.js version: $$(node --version)"
	@echo "ï¿½ NPM version: $$(npm --version)"
	@echo "ï¿½ Application version: $(VERSION)-$(BUILD_ID)"
	@npm install --legacy-peer-deps
	@echo "âœ… Dependencies installed successfully!"

api@setup: api@install ## ðŸš€ Complete project setup (install + environment check)
	cd src/api
	@echo "ðŸš€ Setting up $(PROJECT_TITLE) development environment..."
	@$(MAKE) deps-check
	@$(MAKE) type-check
	@echo "âœ… Project setup complete! Run 'make dev' to start development."

#===================================================================================================
#=== Build Targets
#===================================================================================================

api@build: ## ðŸ”¨ Build Azure Functions backend for production
	cd src/api
	@echo "ðŸ”¨ Building Azure Functions backend for production..."
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@echo "ðŸ“‹ Node.js version: $$(node --version)"
	@echo "ï¿½ NPM version: $$(npm --version)"
	@echo "ðŸ§¹ Cleaning previous build..."
	@rm -rf dist/
	@echo "ðŸ”¨ Building with NestJS..."
	@npm run build
	@echo "âœ… Backend built successfully!"
	@echo "ï¿½ Built files are in the dist/ directory:"
	@ls -la dist/ | head -10
	@echo "ï¿½ Build size analysis:"
	@du -sh dist/
	@echo "ðŸŽ‰ Backend build complete!"

api@build-staging: ## ï¿½ Build application for staging environment
	cd src/api
	@echo "ðŸ”¨ Building $(PROJECT_TITLE) for staging..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@NODE_ENV=staging VITE_APP_VERSION=$(VERSION)-staging VITE_BUILD_ID=$(BUILD_ID) npm run build
	@echo "âœ… Staging build complete!"

api@build-analyze: build ## ï¿½ Build and analyze bundle size
	cd src/api
	@echo "ï¿½ Analyzing bundle size..."
	@npx vite-bundle-analyzer dist/


#===================================================================================================
#=== Development Targets
#===================================================================================================

api@dev-check: ## ðŸ” Run pre-development checks (types, lint, format)
	cd src/api
	@echo "ðŸ” Running pre-development checks..."
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@npm run dev:check
	@echo "âœ… Pre-development checks passed!"

api@dev: ## ðŸš€ Start Azure Functions backend in hybrid mode
	cd src/api
	@echo "ðŸš€ Starting Azure Functions backend in hybrid mode..."
	@echo "ðŸ“ Functions will be available at: http://localhost:$(API_FAPP_DEV_PORT)"
	@echo "ðŸ—ï¸ Architecture: Hybrid (NestJS HTTP + Native Triggers)"
	@echo "ðŸ“– API endpoints:"
	@echo "  â€¢ POST /api/storage/generate-sas - Generate SAS tokens"
	@echo "  â€¢ POST /api/validation/uuid - Validate UUIDs"
	@echo "  â€¢ GET  /api/health - Health check"
	@echo "  â€¢ GET  /api/docs - Swagger documentation"
	@echo "âš¡ Native Functions:"
	@echo "  â€¢ Timer: schedule-cleanup (daily at 2 AM UTC)"
	@echo "  â€¢ Queue: queue-processor (task-queue)"
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@echo "ï¿½ Node.js version: $$(node --version)"
	@echo NODE_ENV=$(NODE_ENV)
	npm run dev

api@dev-nestjs: ## ðŸš€ Start NestJS HTTP development server (without pre-checks)
	cd src/api
	@echo "ðŸš€ Starting NestJS HTTP development server..."
	@echo "ðŸ“ Server will be available at: http://localhost:$(API_NEST_DEV_PORT)"
	@echo "ðŸ“– API docs will be available at: http://localhost:$(API_NEST_DEV_PORT)/api/docs"
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@npm run start:debug

api@dev-adapter: ## ðŸš€ Start NestJS with Serverless Adapter (development)
	cd src/api
	@echo "ðŸš€ Starting NestJS with H4AD Serverless Adapter..."
	@echo "ðŸ“ Server will be available at: http://localhost:$(API_NEST_DEV_PORT)"
	@echo "ðŸ“– API docs will be available at: http://localhost:$(API_NEST_DEV_PORT)/api/docs"
	@echo "ðŸ”§ Architecture: H4AD Serverless Adapter + NestJS"
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@npm run start:adapter

api@dev-strict: ## ðŸš€ Start development server with strict pre-checks + Azure Storage Emulator
	cd src/api
	@echo "ðŸš€ Starting $(PROJECT_TITLE) development server with strict checks..."
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	@echo "ðŸ“‹ Node.js version: $$(node --version)"
	@echo "ðŸ” Running pre-development checks..."
	@$(MAKE) dev-check
	@echo "âœ… Pre-development checks passed!"
	@echo "ðŸŒ Starting parallel services with Azure Storage Emulator..."
	npm run dev:strict

api@preview: api@build ## ðŸ” Preview production build locally
	cd src/api
	@echo "ï¿½ Starting preview server for production build..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@echo "ðŸ“‹ Node.js version: $$(node --version)"
	@echo "ðŸŒ Starting preview server on http://$(DEV_HOST):$(PREVIEW_PORT)"
	@npm run preview

api@serve: api@build ## ðŸŒ Serve production build locally
	cd src/api
	@echo "ðŸŒ Serving production build..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@echo "ðŸ“ Serving from dist/ directory"
	@npx serve dist -p $(DEV_PORT) -s
	@echo "ðŸŒ Application available at http://$(DEV_HOST):$(DEV_PORT)"

#===================================================================================================
#=== Security and Maintenance Targets
#===================================================================================================

api@audit: ## ðŸ”’ Run npm security audit
	cd src/api
	@echo "ï¿½ Running security audit..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@npm audit --audit-level=moderate
	@echo "âœ… Security audit completed!"

api@security-audit: ## ðŸ”’ Run comprehensive security audit with fix suggestions
	cd src/api
	@echo "ï¿½ Running comprehensive security audit..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@npm audit --audit-level=low
	@echo "ðŸ’¡ To fix issues automatically, run: npm audit fix"
	@echo "âœ… Security audit completed!"

api@update: ## ðŸ“¦ Update npm dependencies (interactive)
	cd src/api
	@echo "ï¿½ Updating dependencies..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@npx npm-check-updates --interactive
	@echo "âœ… Dependencies updated!"

api@deps-check: ## ðŸ” Check for outdated dependencies
	cd src/api
	@echo "ï¿½ Checking for outdated dependencies..."
	@source ${NVM_DIR}/nvm.sh
	@nvm use ${NVM_NODE_VERSION}
	@npm outdated || true
	@echo "âœ… Dependency check completed!"

#===================================================================================================
#=== Azure Functions Specific Targets
#===================================================================================================



api@start: ## âš¡ Start Azure Functions backend
	cd src/api
	@echo "âš¡ Starting Azure Functions backend..."
	@echo "ðŸ“ Functions Host: http://localhost:$(API_FAPP_DEV_PORT)"
	@source ${NVM_DIR}/nvm.sh && nvm use ${NVM_NODE_VERSION}
	func start --port $(API_FAPP_DEV_PORT)

api@stop: ## â¹ï¸ Stop Azure Functions backend
	cd src/api
	@echo "â¹ï¸ Stopping Azure Functions backend..."
	pkill -f "func start" || true
	pkill -f "Azure.Functions.Cli" || true
	@echo "âœ… Azure Functions stopped"

api@status: ## ðŸ“Š Check backend status
	cd src/api
	@echo "ðŸ“Š Azure Functions backend status:"
	@if pgrep -f "func start" > /dev/null; then \
		echo "âœ… Backend is running"; \
		echo "ðŸ“ Available at: http://localhost:$(API_FAPP_DEV_PORT)"; \
	else \
		echo "âŒ Backend is not running"; \
	fi

api@logs: ## ðŸ“‹ Show backend logs
	cd src/api
	@echo "ðŸ“‹ Showing Azure Functions logs..."
	@if [ -f "$(HOME)/.azure-functions-core-tools/logs/host.log" ]; then \
		tail -f "$(HOME)/.azure-functions-core-tools/logs/host.log"; \
	else \
		echo "âš ï¸ No log file found. Make sure Azure Functions is running."; \
	fi

api@health: ## ðŸ¥ Check backend health
	cd src/api
	@echo "ðŸ¥ Checking backend health..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "âœ… Backend is healthy"; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/health | jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/health; \
	else \
		echo "âŒ Backend is not responding"; \
		echo "ðŸ’¡ Start it with: make api@dev"; \
	fi

api@test-sas: ## ðŸ” Test SAS token generation
	cd src/api
	@echo "ðŸ” Testing SAS token generation..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Sending SAS token request..."; \
		curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/storage/sas-tokens \
			-H "Content-Type: application/json" \
			-d '{"fileName": "test-document.pdf", "contentType": "application/pdf"}' \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@test-validation: ## âœ… Test validation endpoints
	cd src/api
	@echo "âœ… Testing validation endpoints..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Testing UUID validation..."; \
		curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/validation/uuids \
			-H "Content-Type: application/json" \
			-d '{"uuid": "123e4567-e89b-12d3-a456-426614174000"}' \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@docs: ## ðŸ“– Open API documentation
	cd src/api
	@echo "ðŸ“– Opening API documentation..."
	@if command -v xdg-open > /dev/null; then \
		xdg-open http://localhost:$(API_FAPP_DEV_PORT)/api/docs; \
	elif command -v open > /dev/null; then \
		open http://localhost:$(API_FAPP_DEV_PORT)/api/docs; \
	else \
		echo "ðŸ“ API docs available at: http://localhost:$(API_FAPP_DEV_PORT)/api/docs"; \
	fi

api@docs-nestjs: ## ðŸ“– Open NestJS API documentation
	cd src/api
	@echo "ðŸ“– Opening NestJS API documentation..."
	@if command -v xdg-open > /dev/null; then \
		xdg-open http://localhost:$(API_NEST_DEV_PORT)/api/docs; \
	elif command -v open > /dev/null; then \
		open http://localhost:$(API_NEST_DEV_PORT)/api/docs; \
	else \
		echo "ðŸ“ NestJS API docs available at: http://localhost:$(API_NEST_DEV_PORT)/api/docs"; \
	fi

#===================================================================================================
#=== Payment API Testing Targets
#===================================================================================================

api@test-payment-status: ## ðŸ¥ Test development service status (legacy)
	cd src/api
	@echo "ðŸ¥ Testing development service status..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "âœ… Development service is running"; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/status | jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/status; \
	else \
		echo "âŒ Development service is not responding"; \
		echo "ðŸ’¡ Start it with: make api@dev"; \
	fi

api@create-reservation: ## ðŸ“ Create a sample tourist tax reservation
	cd src/api
	@echo "ðŸ“ Creating sample tourist tax reservation..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Sending reservation creation request..."; \
		curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/reservations \
			-H "Content-Type: application/json" \
			-d '{"guestName":"Jan Kowalski","guestEmail":"jan.kowalski@example.com","accommodationName":"Hotel Test","accommodationAddress":"ul. Testowa 1, 31-000 KrakÃ³w","checkInDate":"2025-08-15","checkOutDate":"2025-08-18","numberOfGuests":2,"numberOfNights":3,"taxAmountPerNight":2.50,"totalTaxAmount":15.00,"currency":"PLN","cityName":"KrakÃ³w"}' \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@list-reservations: ## ðŸ“‹ List all reservations
	cd src/api
	@echo "ðŸ“‹ Fetching all reservations..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Fetching reservations..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/reservations \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/reservations; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@initiate-payment: ## ðŸ’³ Initiate payment for a reservation (requires RESERVATION_ID)
	cd src/api
	@echo "ðŸ’³ Initiating payment for reservation..."
	@if [ -z "$(RESERVATION_ID)" ]; then \
		echo "âŒ RESERVATION_ID is required. Usage: make api@initiate-payment RESERVATION_ID=your-uuid"; \
		echo "ðŸ’¡ Get reservation IDs with: make api@list-reservations"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Initiating payment for reservation $(RESERVATION_ID)..."; \
		curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payments \
			-H "Content-Type: application/json" \
			-d '{"reservationId":"$(RESERVATION_ID)","successUrl":"http://localhost:3040/payment/success","failureUrl":"http://localhost:3040/payment/failure"}' \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@payment-status: ## ðŸ“Š Check payment status (requires PAYMENT_ID)
	cd src/api
	@echo "ðŸ“Š Checking payment status..."
	@if [ -z "$(PAYMENT_ID)" ]; then \
		echo "âŒ PAYMENT_ID is required. Usage: make api@payment-status PAYMENT_ID=your-payment-id"; \
		echo "ðŸ’¡ Get payment IDs with: make api@list-payments"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Fetching payment status for $(PAYMENT_ID)..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payments/$(PAYMENT_ID)/status \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payments/$(PAYMENT_ID)/status; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@list-payments: ## ðŸ’° List all payments
	cd src/api
	@echo "ðŸ’° Fetching all payments..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Fetching payments..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payments \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payments; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@simulate-webhook: ## ðŸ”” Simulate payment webhook (requires PAYMENT_ID and STATUS)
	cd src/api
	@echo "ðŸ”” Simulating payment webhook..."
	@if [ -z "$(PAYMENT_ID)" ]; then \
		echo "âŒ PAYMENT_ID is required. Usage: make api@simulate-webhook PAYMENT_ID=your-payment-id STATUS=completed"; \
		echo "ðŸ’¡ Valid statuses: pending, processing, completed, failed, cancelled"; \
		exit 1; \
	fi
	@if [ -z "$(STATUS)" ]; then \
		echo "âŒ STATUS is required. Usage: make api@simulate-webhook PAYMENT_ID=your-payment-id STATUS=completed"; \
		echo "ðŸ’¡ Valid statuses: pending, processing, completed, failed, cancelled"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Sending webhook for payment $(PAYMENT_ID) with status $(STATUS)..."; \
		curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payments/webhooks \
			-H "Content-Type: application/json" \
			-d "{\"paymentId\":\"$(PAYMENT_ID)\",\"status\":\"$(STATUS)\",\"amount\":15.00,\"currency\":\"PLN\",\"transactionId\":\"txn_$$(date +%s)_test\",\"timestamp\":\"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@get-reservation: ## ðŸ” Get specific reservation (requires RESERVATION_ID)
	cd src/api
	@echo "ðŸ” Fetching reservation details..."
	@if [ -z "$(RESERVATION_ID)" ]; then \
		echo "âŒ RESERVATION_ID is required. Usage: make api@get-reservation RESERVATION_ID=your-uuid"; \
		echo "ðŸ’¡ Get reservation IDs with: make api@list-reservations"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Fetching reservation $(RESERVATION_ID)..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/reservations/$(RESERVATION_ID) \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/reservations/$(RESERVATION_ID); \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@delete-reservation: ## ðŸ—‘ï¸ Delete specific reservation (requires RESERVATION_ID)
	cd src/api
	@echo "ðŸ—‘ï¸ Deleting reservation..."
	@if [ -z "$(RESERVATION_ID)" ]; then \
		echo "âŒ RESERVATION_ID is required. Usage: make api@delete-reservation RESERVATION_ID=your-uuid"; \
		echo "ðŸ’¡ Get reservation IDs with: make api@list-reservations"; \
		exit 1; \
	fi
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Deleting reservation $(RESERVATION_ID)..."; \
		curl -X DELETE http://localhost:$(API_NEST_DEV_PORT)/api/reservations/$(RESERVATION_ID) \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@clear-payment-data: ## ðŸ§¹ Clear all payment data and reseed with mock data
	cd src/api
	@echo "ðŸ§¹ Clearing all payment data..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Clearing all data..."; \
		curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/dev/reset \
			| jq . || echo "Response received (jq not available)"; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@demo-payment-flow: ## ðŸŽ¬ Run complete payment flow demo
	cd src/api
	@echo "ðŸŽ¬ Running complete payment flow demo..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo ""; \
		echo "ðŸŽ¯ Step 1: Creating reservation..."; \
		RESERVATION_RESPONSE=$$(curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/reservations \
			-H "Content-Type: application/json" \
			-d '{"guestName":"Demo User","guestEmail":"demo@example.com","accommodationName":"Demo Hotel","accommodationAddress":"ul. Demo 1, 31-000 KrakÃ³w","checkInDate":"2025-08-15","checkOutDate":"2025-08-17","numberOfGuests":1,"numberOfNights":2,"taxAmountPerNight":2.50,"totalTaxAmount":5.00,"currency":"PLN","cityName":"KrakÃ³w"}'); \
		RESERVATION_ID=$$(echo $$RESERVATION_RESPONSE | jq -r '.id' 2>/dev/null || echo ""); \
		if [ -n "$$RESERVATION_ID" ] && [ "$$RESERVATION_ID" != "null" ]; then \
			echo "âœ… Reservation created: $$RESERVATION_ID"; \
			echo ""; \
			echo "ðŸŽ¯ Step 2: Initiating payment..."; \
			PAYMENT_RESPONSE=$$(curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payments \
				-H "Content-Type: application/json" \
				-d "{ \
					\"reservationId\": \"$$RESERVATION_ID\", \
					\"successUrl\": \"http://localhost:3040/payment/success\", \
					\"failureUrl\": \"http://localhost:3040/payment/failure\" \
				}"); \
			PAYMENT_ID=$$(echo $$PAYMENT_RESPONSE | jq -r '.paymentId' 2>/dev/null || echo ""); \
			if [ -n "$$PAYMENT_ID" ] && [ "$$PAYMENT_ID" != "null" ]; then \
				echo "âœ… Payment initiated: $$PAYMENT_ID"; \
				echo ""; \
				echo "ðŸŽ¯ Step 3: Simulating payment completion..."; \
				sleep 2; \
				curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payments/webhooks \
					-H "Content-Type: application/json" \
					-d "{\"paymentId\":\"$$PAYMENT_ID\",\"status\":\"processing\",\"amount\":5.00,\"currency\":\"PLN\",\"transactionId\":\"txn_demo_$$(date +%s)\",\"timestamp\":\"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > /dev/null; \
				sleep 1; \
				curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/payments/webhooks \
					-H "Content-Type: application/json" \
					-d "{\"paymentId\":\"$$PAYMENT_ID\",\"status\":\"completed\",\"amount\":5.00,\"currency\":\"PLN\",\"transactionId\":\"txn_demo_$$(date +%s)\",\"timestamp\":\"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > /dev/null; \
				echo "âœ… Payment completed via webhook"; \
				echo ""; \
				echo "ðŸŽ¯ Step 4: Checking final status..."; \
				curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payments/$$PAYMENT_ID/status | jq . || echo "Final status check completed"; \
				echo ""; \
				echo "ðŸŽ‰ Demo completed successfully!"; \
				echo "ðŸ“ Reservation ID: $$RESERVATION_ID"; \
				echo "ðŸ“ Payment ID: $$PAYMENT_ID"; \
			else \
				echo "âŒ Failed to initiate payment"; \
			fi; \
		else \
			echo "âŒ Failed to create reservation"; \
		fi; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

# === Development Utilities ===

api@dev-status: ## ðŸ”§ Check development environment status
	cd src/api
	@echo "ðŸ”§ Checking development environment status..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Fetching development status..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/status \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/status; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@dev-stats: ## ðŸ“Š Get development statistics
	cd src/api
	@echo "ðŸ“Š Fetching development statistics..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Fetching development stats..."; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/stats \
			| jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/stats; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@dev-seed: ## ðŸŒ± Seed test data
	cd src/api
	@echo "ðŸŒ± Seeding test data..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Seeding test data..."; \
		curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/dev/seed \
			| jq . || curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/dev/seed; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@dev-clear: ## ðŸ§¹ Clear all development data
	cd src/api
	@echo "ðŸ§¹ Clearing all development data..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Clearing all data..."; \
		curl -s -X DELETE http://localhost:$(API_NEST_DEV_PORT)/api/dev/data \
			| jq . || curl -s -X DELETE http://localhost:$(API_NEST_DEV_PORT)/api/dev/data; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi

api@dev-reset: ## ðŸ”„ Reset all data (clear + seed)
	cd src/api
	@echo "ðŸ”„ Resetting all development data..."
	@if curl -s -f http://localhost:$(API_NEST_DEV_PORT)/api/health > /dev/null 2>&1; then \
		echo "ðŸ“¡ Resetting all data..."; \
		curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/dev/reset \
			| jq . || curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/dev/reset; \
	else \
		echo "âŒ Backend is not running. Start it with: make api@dev"; \
	fi


api@test: ## ðŸ§ª Run comprehensive API tests with real data
	cd src/api
	@echo "ðŸ§ª Running comprehensive API tests..."
	@echo ""
	@echo "=== ðŸ¥ Health Checks ==="
	@echo "# Basic health check"
	@curl -s http://localhost:$(API_NEST_DEV_PORT)/api/health | jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/health
	@echo ""
	@echo "# Readiness check (checks Azure Storage connectivity)"
	@curl -s http://localhost:$(API_NEST_DEV_PORT)/api/health/ready | jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/health/ready
	@echo ""
	@echo "# Liveness check"
	@curl -s http://localhost:$(API_NEST_DEV_PORT)/api/health/live | jq . || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/health/live
	@echo ""
	@echo ""
	@echo "=== ðŸ—„ï¸ Storage & Validation ==="
	@echo "# Generate SAS token for blob storage"
	@curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/storage/sas-tokens \
		-H "Content-Type: application/json" \
		-d '{"fileName": "test-document.pdf", "contentType": "application/pdf"}' \
		| jq . || curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/storage/sas-tokens \
		-H "Content-Type: application/json" \
		-d '{"fileName": "test-document.pdf", "contentType": "application/pdf"}'
	@echo ""
	@echo "# Validate UUID"
	@curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/validation/uuids \
		-H "Content-Type: application/json" \
		-d '{"uuid": "123e4567-e89b-12d3-a456-426614174000"}' \
		| jq . || curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/validation/uuids \
		-H "Content-Type: application/json" \
		-d '{"uuid": "123e4567-e89b-12d3-a456-426614174000"}'
	@echo ""
	@echo ""
	@echo "=== ðŸ“‹ Reservations Resource ==="
	@echo "# Get all reservations"
	@RESERVATIONS_RESPONSE=$$(curl -s http://localhost:$(API_NEST_DEV_PORT)/api/reservations); \
	echo "$$RESERVATIONS_RESPONSE" | jq . 2>/dev/null || echo "$$RESERVATIONS_RESPONSE"; \
	FIRST_RESERVATION_ID=$$(echo "$$RESERVATIONS_RESPONSE" | jq -r '.[0].id' 2>/dev/null || echo ""); \
	echo ""; \
	if [ -n "$$FIRST_RESERVATION_ID" ] && [ "$$FIRST_RESERVATION_ID" != "null" ]; then \
		echo "# Get specific reservation (using first reservation: $$FIRST_RESERVATION_ID)"; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/reservations/$$FIRST_RESERVATION_ID | jq . 2>/dev/null || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/reservations/$$FIRST_RESERVATION_ID; \
		echo ""; \
	else \
		echo "# No reservations found to test specific reservation endpoint"; \
		echo ""; \
	fi
	@echo "# Create new reservation"
	@NEW_RESERVATION_RESPONSE=$$(curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/reservations \
		-H "Content-Type: application/json" \
		-d '{"guestName": "API Test User", "guestEmail": "apitest@example.com", "accommodationName": "API Test Hotel", "accommodationAddress": "ul. Test API 1, 31-000 KrakÃ³w", "checkInDate": "2025-08-15", "checkOutDate": "2025-08-18", "numberOfGuests": 2, "numberOfNights": 3, "taxAmountPerNight": 2.50, "totalTaxAmount": 15.00, "currency": "PLN", "cityName": "KrakÃ³w"}'); \
	echo "$$NEW_RESERVATION_RESPONSE" | jq . 2>/dev/null || echo "$$NEW_RESERVATION_RESPONSE"; \
	NEW_RESERVATION_ID=$$(echo "$$NEW_RESERVATION_RESPONSE" | jq -r '.id' 2>/dev/null || echo ""); \
	echo ""
	@echo ""
	@echo "=== ðŸ’³ Payments Resource ==="
	@echo "# Get all payments"
	@PAYMENTS_RESPONSE=$$(curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payments); \
	echo "$$PAYMENTS_RESPONSE" | jq . 2>/dev/null || echo "$$PAYMENTS_RESPONSE"; \
	FIRST_PAYMENT_ID=$$(echo "$$PAYMENTS_RESPONSE" | jq -r '.[0].paymentId' 2>/dev/null || echo ""); \
	echo ""; \
	if [ -n "$$FIRST_PAYMENT_ID" ] && [ "$$FIRST_PAYMENT_ID" != "null" ]; then \
		echo "# Get payment status (using first payment: $$FIRST_PAYMENT_ID)"; \
		curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payments/$$FIRST_PAYMENT_ID/status | jq . 2>/dev/null || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/payments/$$FIRST_PAYMENT_ID/status; \
		echo ""; \
	else \
		echo "# No payments found to test payment status endpoint"; \
		echo ""; \
	fi
	@echo ""
	@echo "=== ðŸ”§ Development Endpoints ==="
	@echo "# Get development status"
	@curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/status | jq . 2>/dev/null || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/status
	@echo ""
	@echo "# Get development statistics"
	@curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/stats | jq . 2>/dev/null || curl -s http://localhost:$(API_NEST_DEV_PORT)/api/dev/stats
	@echo ""
	@echo "# Reset all data (clear and reseed)"
	@curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/dev/reset | jq . 2>/dev/null || curl -s -X POST http://localhost:$(API_NEST_DEV_PORT)/api/dev/reset
	@echo ""
	@echo "âœ… API tests completed!"

api@test-simple: ## ðŸ§ª Run simple API tests (updated endpoints)
	echo '# Basic health check'
	curl http://localhost:$(API_NEST_DEV_PORT)/api/health
	echo
	echo '# Readiness check (checks Azure Storage connectivity)'
	curl http://localhost:$(API_NEST_DEV_PORT)/api/health/ready
	echo
	echo '# Liveness check'
	curl http://localhost:$(API_NEST_DEV_PORT)/api/health/live
	echo
	echo '# Generate SAS token for blob storage'
	curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/storage/sas-tokens \
	-H "Content-Type: application/json" \
	-d '{"fileName": "test-document.pdf", "contentType": "application/pdf"}'
	echo
	echo '# Validate UUID'
	curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/validation/uuids \
	-H "Content-Type: application/json" \
	-d '{"uuid": "123e4567-e89b-12d3-a456-426614174000"}'
	echo
	echo '# Get all reservations'
	curl http://localhost:$(API_NEST_DEV_PORT)/api/reservations
	echo
	echo '# Get all payments'
	curl http://localhost:$(API_NEST_DEV_PORT)/api/payments
	echo
	echo '# Reset all data'
	curl -X POST http://localhost:$(API_NEST_DEV_PORT)/api/dev/reset
	echo
